## Metadata Header
> **Branch:** develop
> **Last Commit:** HEAD (Generated by Agent)
> **Last Updated:** Wed Jan 21 2026

## Title & TL;DR
**Wonkers Nedap** is an integration service that connects TinyBots with the **Nedap ONS** healthcare platform. It synchronizes "concepts" (orders and returns) by polling Nedap ONS surveys and pushes them to the `wonkers-taas-orders` service, while also managing the certificates required for secure ONS API communication.

## Recent Changes Log (Only if Updating)
Initial Documentation.

## Repo Purpose & Bounded Context
- **Role:** Integration Bridge & Sync Service.
- **Domain:** Healthcare Integration / TaaS (Transport as a Service) Order Management.
- **Responsibility:**
    - Authenticates with Nedap ONS using mutual TLS (certificates).
    - Polls Nedap ONS for new Survey Results (orders/returns).
    - Transforms external data into TinyBots "Concept" DTOs.
    - Pushes concepts to `wonkers-taas-orders`.
    - Manages integration configurations and certificate lifecycle.

## Project Structure
- **src/App.ts**: Main application entry point, dependency injection (Awilix), and middleware setup.
- **src/api/**: `OnsNedapApi` client for communicating with external Nedap ONS endpoints.
- **src/controller/**: HTTP controllers for internal triggers and configuration management.
- **src/job/**: Cron jobs for periodic synchronization and validation.
- **src/mappers/**: Logic to transform Nedap ONS data structures into TinyBots DTOs.
- **src/model/**: Data Transfer Objects (DTOs) and internal models.
- **src/repository/**: Data access layer for persisting certificates and sync state.
- **src/service/**: Core business logic (Coordination of API calls, transformation, and downstream pushing).

## Controllers & Public Surface (Inbound)
All endpoints are internal, primarily used for configuration or manual triggers of background processes.

- **Concept Operations (Internal):**
  - `POST /internal/v1/nedap-ons/orders/retrieve`: Manually triggers the job to retrieve orders/returns from Nedap ONS.
  - `POST /internal/v1/nedap-ons/certificates/validate`: Manually triggers the certificate validation job.

- **Certificate Management:**
  - `PUT /v1/nedap-ons/certificates`: Upload or update a client certificate for ONS authentication.

- **Integration Configuration:**
  - `GET /internal/v1/nedap-ons/configs`: List all ONS integration configs.
  - `POST /internal/v1/nedap-ons/configs`: Create a new integration config.
  - `GET /internal/v1/nedap-ons/configs/:configId`: Get details of a specific config.
  - `PATCH /internal/v1/nedap-ons/configs/:configId`: Update a specific config.
  - `DELETE /internal/v1/nedap-ons/configs/:configId`: Remove a config.

## Core Services & Logic (Internal)
- **OnsNedapApi:**
  - Wrapper around `axios` to handle mutual TLS (mTLS) with Nedap ONS.
  - Fetches Surveys, Survey Results, Employees, Teams, and Client details.
- **ConceptService:**
  - Orchestrates the flow: Fetch Survey Results -> Map to Concepts -> Push to Downstream.
- **WonkersTaasOrderService:**
  - Client that posts processed `ConceptOrderDto` and `ConceptReturnDto` to the `wonkers-taas-orders` service.
- **CertificateService:**
  - Manages storage and retrieval of ONS certificates used for authentication.
- **OnsIntegrationConfigService:**
  - CRUD operations for managing which ONS environments are integrated.
- **Jobs:**
  - `retrieveConceptsJob`: Periodically polls ONS for new orders/returns.
  - `certificateValidJob`: Checks and warns about expiring certificates.

## External Dependencies & Cross-Service Contracts (Outbound)
- **Databases:**
  - **MySQL (`wonkers-db`):** Stores ONS configurations (`OnsIntegrationConfigRepository`), certificates (`CertificateRepository`), and processing history (`ProcessedOrderRepository`).
- **External APIs:**
  - **Nedap ONS API:** External healthcare platform (upstream source of data).
  - **wonkers-taas-orders:** Internal TinyBots service (downstream consumer of orders/returns).
- **Libraries:**
  - `tiny-backend-tools`: Shared infrastructure (MySQL, Logging, Config).
  - `tb-ts-slack-notification`: Alerts and notifications.
